/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
var __awaiter=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(a,n){function o(e){try{d(i.next(e))}catch(e){n(e)}}function r(e){try{d(i.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}d((i=i.apply(e,t||[])).next())}))};define(["require","exports","TYPO3/CMS/Backend/Enum/Severity","jquery","TYPO3/CMS/Backend/Modal","TYPO3/CMS/Backend/Utility","./Workspaces","twbs/bootstrap-slider"],(function(e,t,s,i,a,n,o){"use strict";var r;!function(e){e.topbar="#typo3-topbar",e.workspacePanel=".workspace-panel",e.liveView="#live-view",e.workspaceTabs='.t3js-workspace-tabs [data-toggle="tab"]',e.workspaceActions=".t3js-workspace-actions",e.stageSlider="#workspace-stage-slider",e.workspaceView="#workspace-view",e.workspaceList="#workspace-list",e.sendToStageAction='[data-action="send-to-stage"]',e.discardAction='[data-action="discard"]',e.stageButtonsContainer=".t3js-stage-buttons",e.previewModeContainer=".t3js-preview-mode",e.activePreviewMode=".t3js-active-preview-mode",e.workspacePreview=".t3js-workspace-preview"}(r||(r={}));class d extends o.default{constructor(){super(),this.currentSlidePosition=100,this.elements={},this.updateSlidePosition=e=>{this.currentSlidePosition=e.value.newValue,this.resizeViews()},this.renderDiscardWindow=()=>{const e=a.confirm(TYPO3.lang["window.discardAll.title"],TYPO3.lang["window.discardAll.message"],s.SeverityEnum.warning,[{text:TYPO3.lang.cancel,active:!0,btnClass:"btn-default",name:"cancel",trigger:()=>{e.modal("hide")}},{text:TYPO3.lang.ok,btnClass:"btn-warning",name:"ok"}]);e.on("button.clicked",t=>{"ok"===t.target.name&&this.sendRemoteRequest([this.generateRemoteActionsPayload("discardStagesFromPage",[TYPO3.settings.Workspaces.id]),this.generateRemoteActionsPayload("updateStageChangeButtons",[TYPO3.settings.Workspaces.id])]).then(t=>__awaiter(this,void 0,void 0,(function*(){e.modal("hide"),this.renderStageButtons((yield t.resolve())[1].result),this.elements.$workspaceView.attr("src",this.elements.$workspaceView.attr("src")),this.elements.$workspaceList.attr("src",this.elements.$workspaceList.attr("src"))})))})},this.renderSendPageToStageWindow=e=>{const t=e.currentTarget,s=t.dataset.direction;let i;if("prev"===s)i="sendPageToPreviousStage";else{if("next"!==s)throw"Invalid direction "+s+" requested.";i="sendPageToNextStage"}this.sendRemoteRequest(this.generateRemoteActionsPayload(i,[TYPO3.settings.Workspaces.id])).then(e=>__awaiter(this,void 0,void 0,(function*(){const s=yield e.resolve(),i=this.renderSendToStageWindow(s);i.on("button.clicked",e=>{if("ok"===e.target.name){const a=n.convertFormToObject(e.currentTarget.querySelector("form"));a.affects=s[0].result.affects,a.stageId=t.dataset.stageId,this.sendRemoteRequest([this.generateRemoteActionsPayload("sentCollectionToStage",[a]),this.generateRemoteActionsPayload("updateStageChangeButtons",[TYPO3.settings.Workspaces.id])]).then(e=>__awaiter(this,void 0,void 0,(function*(){i.modal("hide"),this.renderStageButtons((yield e.resolve())[1].result)})))}})})))},this.changePreviewMode=e=>{e.preventDefault();const t=i(e.currentTarget),s=this.elements.$activePreviewMode.data("activePreviewMode"),a=t.data("previewMode");this.elements.$activePreviewMode.text(t.text()).data("activePreviewMode",a),this.elements.$workspacePreview.parent().removeClass("preview-mode-"+s).addClass("preview-mode-"+a),"slider"===a?(this.elements.$stageSlider.parent().toggle(!0),this.resizeViews()):(this.elements.$stageSlider.parent().toggle(!1),"vbox"===a?this.elements.$liveView.height("100%"):this.elements.$liveView.height("50%"))},i(()=>{this.getElements(),this.resizeViews(),this.adjustPreviewModeSelectorWidth(),this.elements.$stageSlider.slider(),this.registerEvents()})}static getAvailableSpace(){return i(window).height()-i(r.topbar).outerHeight()}getElements(){this.elements.$liveView=i(r.liveView),this.elements.$workspacePanel=i(r.workspacePanel),this.elements.$workspaceTabs=i(r.workspaceTabs),this.elements.$workspaceActions=i(r.workspaceActions),this.elements.$stageSlider=i(r.stageSlider),this.elements.$workspaceView=i(r.workspaceView),this.elements.$workspaceList=i(r.workspaceList),this.elements.$stageButtonsContainer=i(r.stageButtonsContainer),this.elements.$previewModeContainer=i(r.previewModeContainer),this.elements.$activePreviewMode=i(r.activePreviewMode),this.elements.$workspacePreview=i(r.workspacePreview)}registerEvents(){i(window).on("resize",()=>{this.resizeViews()}),i(document).on("click",r.discardAction,this.renderDiscardWindow).on("click",r.sendToStageAction,this.renderSendPageToStageWindow),this.elements.$workspaceTabs.on("show.bs.tab",e=>{this.elements.$workspaceActions.toggle(e.currentTarget.dataset.actions)}),this.elements.$stageSlider.on("change",this.updateSlidePosition),this.elements.$previewModeContainer.find("[data-preview-mode]").on("click",this.changePreviewMode)}renderStageButtons(e){this.elements.$stageButtonsContainer.html(e)}resizeViews(){const e=d.getAvailableSpace(),t=-1*(this.currentSlidePosition-100),s=Math.round(Math.abs(e*t/100)),i=this.elements.$liveView.outerHeight()-this.elements.$liveView.height();this.elements.$workspacePreview.height(e),"slider"===this.elements.$activePreviewMode.data("activePreviewMode")&&this.elements.$liveView.height(s-i),this.elements.$workspaceList.height(e)}adjustPreviewModeSelectorWidth(){const e=this.elements.$previewModeContainer.find(".btn-group");let t=0;e.addClass("open"),this.elements.$previewModeContainer.find("li > a > span").each((e,s)=>{const a=i(s).width();t<a&&(t=a)}),e.removeClass("open"),this.elements.$activePreviewMode.width(t)}}return new d}));